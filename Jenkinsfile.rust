pipeline {
    agent {
        label 'master'
    }
    
    environment {
        DOCKER_REGISTRY = 'registry-vpc.cn-beijing.aliyuncs.com'
        IMAGE_NAME = 'moseeker/jenkins-demo-rust'
        DOCKER_BUILDKIT = '1'
    }
    
    stages {
        stage('Prepare') {
            steps {
                echo "ğŸš€ 1.å‡†å¤‡é˜¶æ®µ - æ£€å‡ºä»£ç "
                checkout scm
                script {
                    // ä½¿ç”¨Gitå‘½ä»¤è·å–æäº¤ä¿¡æ¯
                    env.BUILD_TAG = sh(
                        returnStdout: true, 
                        script: 'git rev-parse --short HEAD'
                    ).trim()
                    
                    env.BUILD_TIME = sh(
                        returnStdout: true,
                        script: 'date "+%Y%m%d-%H%M%S"'
                    ).trim()
                    
                    if (env.BRANCH_NAME != 'master') {
                        env.BUILD_TAG = "${env.BRANCH_NAME}-${env.BUILD_TAG}"
                    }
                    
                    echo "æ„å»ºæ ‡ç­¾: ${env.BUILD_TAG}"
                    echo "åˆ†æ”¯åç§°: ${env.BRANCH_NAME}"
                }
            }
        }
        
        stage('Test') {
            steps {
                echo "ğŸ§ª 2.åŠŸèƒ½æµ‹è¯•é˜¶æ®µ"
                script {
                    try {
                        // Rustç¼–è¯‘æ£€æŸ¥
                        sh 'docker run --rm -v $(pwd):/workspace -w /workspace rust:1.75-alpine sh -c "apk add --no-cache musl-dev && cargo check"'
                        
                        // æ„å»ºå¹¶æµ‹è¯•
                        sh 'docker build -t jenkins-demo-rust-test .'
                        sh 'docker run -d --name test-container -p 8080:8080 jenkins-demo-rust-test'
                        sh 'sleep 5'
                        sh 'curl -f http://localhost:8080/health || exit 1'
                        sh 'curl -f http://localhost:8080/api/info || exit 1'
                        sh 'docker stop test-container && docker rm test-container'
                        
                        echo "âœ… åŠŸèƒ½æµ‹è¯•é€šè¿‡"
                    } catch (Exception e) {
                        echo "âŒ æµ‹è¯•å¤±è´¥: ${e.message}"
                        sh 'docker stop test-container && docker rm test-container || true'
                        throw e
                    }
                }
            }
        }
        
        stage('Security Scan') {
            steps {
                echo "ğŸ”’ 3.å®‰å…¨æ‰«æ (Rustç‰ˆæœ¬è·³è¿‡Goç‰¹å®šæ£€æŸ¥)"
                script {
                    try {
                        // Dockerå®‰å…¨æ‰«æ (å¦‚æœæœ‰å·¥å…·çš„è¯)
                        echo "Rustç‰ˆæœ¬å®‰å…¨æ£€æŸ¥..."
                        // sh 'cargo audit' // éœ€è¦å®‰è£…cargo-audit
                        echo "âœ… å®‰å…¨æ‰«æå®Œæˆ"
                    } catch (Exception e) {
                        echo "âš ï¸ å®‰å…¨æ‰«æè­¦å‘Š: ${e.message}"
                        // å®‰å…¨æ‰«æå¤±è´¥ä¸é˜»æ–­æ„å»ºï¼Œä½†è®°å½•è­¦å‘Š
                    }
                }
            }
        }
        
        stage('Build') {
            steps {
                echo "ğŸ”¨ 4.æ„å»ºDockeré•œåƒ"
                script {
                    try {
                        sh """
                            docker build \
                                --build-arg BUILD_TIME=${env.BUILD_TIME} \
                                --build-arg BUILD_TAG=${env.BUILD_TAG} \
                                --build-arg BRANCH_NAME=${env.BRANCH_NAME} \
                                -t ${DOCKER_REGISTRY}/${IMAGE_NAME}:${env.BUILD_TAG} \
                                -t ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest \
                                .
                        """
                        
                        echo "âœ… é•œåƒæ„å»ºæˆåŠŸ: ${env.BUILD_TAG}"
                    } catch (Exception e) {
                        echo "âŒ é•œåƒæ„å»ºå¤±è´¥: ${e.message}"
                        throw e
                    }
                }
            }
        }
        
        stage('Push') {
            steps {
                echo "ğŸ“¤ 5.æ¨é€Dockeré•œåƒ"
                script {
                    // ä½¿ç”¨Jenkinså‡­æ®ç®¡ç†
                    withCredentials([usernamePassword(
                        credentialsId: 'aliyun-docker-registry',
                        usernameVariable: 'DOCKER_USERNAME',
                        passwordVariable: 'DOCKER_PASSWORD'
                    )]) {
                        sh '''
                            echo $DOCKER_PASSWORD | docker login $DOCKER_REGISTRY \
                                --username $DOCKER_USERNAME --password-stdin
                            
                            docker push $DOCKER_REGISTRY/$IMAGE_NAME:$BUILD_TAG
                            docker push $DOCKER_REGISTRY/$IMAGE_NAME:latest
                            
                            echo "âœ… é•œåƒæ¨é€æˆåŠŸ"
                        '''
                    }
                }
            }
            post {
                always {
                    // æ¸…ç†æœ¬åœ°é•œåƒ
                    sh "docker rmi ${DOCKER_REGISTRY}/${IMAGE_NAME}:${env.BUILD_TAG} || true"
                    sh "docker rmi ${DOCKER_REGISTRY}/${IMAGE_NAME}:latest || true"
                }
            }
        }
        
        stage('Deploy') {
            steps {
                echo "ğŸš€ 6.éƒ¨ç½²é˜¶æ®µ"
                script {
                    if (env.BRANCH_NAME == 'master') {
                        // ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²éœ€è¦äººå·¥ç¡®è®¤
                        input message: "ç¡®è®¤è¦éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒå—ï¼Ÿ", 
                              ok: "ç¡®è®¤éƒ¨ç½²", 
                              submitterParameter: 'DEPLOYER'
                        
                        echo "å¼€å§‹éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ..."
                        echo "éƒ¨ç½²è€…: ${env.DEPLOYER}"
                        
                        // æ›´æ–°k8s.yamlä¸­çš„é•œåƒæ ‡ç­¾
                        sh """
                            sed -i 's|image: .*jenkins-demo.*|image: ${DOCKER_REGISTRY}/${IMAGE_NAME}:${env.BUILD_TAG}|g' k8s.yaml
                        """
                        
                        // åº”ç”¨åˆ°Kubernetes
                        sh 'kubectl apply -f k8s.yaml'
                        
                        echo "âœ… ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å®Œæˆ"
                    } else {
                        echo "émasteråˆ†æ”¯ï¼Œè·³è¿‡éƒ¨ç½²é˜¶æ®µ"
                    }
                }
            }
        }
    }
    
    post {
        always {
            echo "ğŸ æ„å»ºå®Œæˆ"
            
            // æ¸…ç†å·¥ä½œç©ºé—´ï¼ˆå¯é€‰ï¼‰
            // deleteDir()
            
            // å‘é€é‚®ä»¶é€šçŸ¥ï¼ˆéœ€è¦é…ç½®é‚®ä»¶æœåŠ¡å™¨ï¼‰
            script {
                def buildStatus = currentBuild.result ?: 'SUCCESS'
                def color = buildStatus == 'SUCCESS' ? 'good' : 'danger'
                def emoji = buildStatus == 'SUCCESS' ? 'âœ…' : 'âŒ'
                
                echo "${emoji} æ„å»ºçŠ¶æ€: ${buildStatus}"
                echo "åˆ†æ”¯: ${env.BRANCH_NAME}"
                echo "æäº¤: ${env.BUILD_TAG}"
                echo "æ„å»ºæ—¶é—´: ${env.BUILD_TIME}"
            }
        }
        
        success {
            echo "ğŸ‰ æ„å»ºæˆåŠŸï¼"
        }
        
        failure {
            echo "ğŸ’¥ æ„å»ºå¤±è´¥ï¼"
        }
        
        unstable {
            echo "âš ï¸ æ„å»ºä¸ç¨³å®šï¼"
        }
    }
} 