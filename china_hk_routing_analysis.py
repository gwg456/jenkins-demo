#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
åˆ†æä¸­å›½å¤§é™†ç”¨æˆ·æ— æ³•è®¿é—®é¦™æ¸¯CloudFrontèŠ‚ç‚¹çš„åŸå› 
æ·±å…¥è§£ææ”¿ç­–ã€æŠ€æœ¯ã€å•†ä¸šç­‰å¤šé‡å› ç´ 
"""

import requests
import socket
import json
from datetime import datetime

class ChinaHKRoutingAnalyzer:
    def __init__(self):
        self.analysis_data = {}
    
    def analyze_policy_factors(self):
        """åˆ†ææ”¿ç­–å’Œåˆè§„å› ç´ """
        print("ğŸ›ï¸ æ”¿ç­–å’Œåˆè§„å› ç´ åˆ†æ")
        print("=" * 60)
        
        policy_factors = {
            "1. ç½‘ç»œå®‰å…¨æ³•åˆè§„": {
                "description": "ä¸­å›½ã€Šç½‘ç»œå®‰å…¨æ³•ã€‹å¯¹è·¨å¢ƒæ•°æ®ä¼ è¾“çš„é™åˆ¶",
                "impact": "é«˜",
                "details": [
                    "ä¸ªäººä¿¡æ¯å’Œé‡è¦æ•°æ®éœ€åœ¨å¢ƒå†…å­˜å‚¨",
                    "è·¨å¢ƒæ•°æ®ä¼ è¾“éœ€è¦å®‰å…¨è¯„ä¼°",
                    "AWSéœ€è¦ç¡®ä¿åˆè§„æ€§ï¼Œé¿å…è¿è§„é£é™©"
                ],
                "aws_response": "é€šè¿‡è·¯ç”±ç­–ç•¥é¿å…æ•æ„Ÿæ•°æ®è·¨å¢ƒä¼ è¾“é£é™©"
            },
            
            "2. æ•°æ®æœ¬åœ°åŒ–è¦æ±‚": {
                "description": "ä¸­å›½è¦æ±‚æŸäº›æ•°æ®å¿…é¡»åœ¨å¢ƒå†…å¤„ç†",
                "impact": "é«˜", 
                "details": [
                    "é‡‘èã€ç”µä¿¡ç­‰è¡Œä¸šæ•°æ®æœ¬åœ°åŒ–è¦æ±‚",
                    "ç”¨æˆ·ä¸ªäººä¿¡æ¯ä¿æŠ¤è¦æ±‚",
                    "æ”¿åºœæ•°æ®å®‰å…¨å®¡æŸ¥"
                ],
                "aws_response": "æ¨åŠ¨ç”¨æˆ·ä½¿ç”¨AWSä¸­å›½åŒºåŸŸ"
            },
            
            "3. ICPå¤‡æ¡ˆåˆ¶åº¦": {
                "description": "åœ¨ä¸­å›½æä¾›äº’è”ç½‘æœåŠ¡éœ€è¦ICPå¤‡æ¡ˆ",
                "impact": "ä¸­ç­‰",
                "details": [
                    "é¦™æ¸¯èŠ‚ç‚¹æœåŠ¡ä¸­å›½å¤§é™†å¯èƒ½è§¦å‘å¤‡æ¡ˆè¦æ±‚",
                    "æœªå¤‡æ¡ˆæœåŠ¡é¢ä¸´åˆè§„é£é™©",
                    "AWSä¸­å›½åŒºåŸŸå·²å®Œæˆç›¸å…³å¤‡æ¡ˆ"
                ],
                "aws_response": "é¿å…é¦™æ¸¯èŠ‚ç‚¹ç›´æ¥æœåŠ¡å¤§é™†ç”¨æˆ·"
            },
            
            "4. è·¨å¢ƒç½‘ç»œç›‘ç®¡": {
                "description": "ä¸­å›½å¯¹è·¨å¢ƒç½‘ç»œè¿æ¥çš„ç‰¹æ®Šç›‘ç®¡",
                "impact": "é«˜",
                "details": [
                    "é•¿åŸé˜²ç«å¢™(GFW)çš„å­˜åœ¨",
                    "è·¨å¢ƒç½‘ç»œè®¿é—®çš„å®¡æŸ¥æœºåˆ¶",
                    "ç‰¹å®šåè®®å’Œç«¯å£çš„é™åˆ¶"
                ],
                "aws_response": "é€šè¿‡å†…åœ°èŠ‚ç‚¹é¿å…è·¨å¢ƒè®¿é—®å®¡æŸ¥"
            }
        }
        
        for key, factor in policy_factors.items():
            print(f"\nğŸ“‹ {key}")
            print(f"   æè¿°: {factor['description']}")
            print(f"   å½±å“ç¨‹åº¦: {factor['impact']}")
            print(f"   å…·ä½“å†…å®¹:")
            for detail in factor['details']:
                print(f"     â€¢ {detail}")
            print(f"   AWSåº”å¯¹: {factor['aws_response']}")
    
    def analyze_technical_factors(self):
        """åˆ†ææŠ€æœ¯å› ç´ """
        print(f"\nğŸ”§ æŠ€æœ¯æ¶æ„å› ç´ åˆ†æ")
        print("=" * 60)
        
        technical_factors = {
            "1. DNSè§£æç­–ç•¥": {
                "description": "AWSçš„DNSæ™ºèƒ½è§£ææœºåˆ¶",
                "technical_detail": "åŸºäºç”¨æˆ·IPåœ°ç†ä½ç½®å’ŒISPä¿¡æ¯è¿›è¡Œè·¯ç”±å†³ç­–",
                "china_impact": [
                    "ä¸­å›½å¤§é™†IPè¢«è¯†åˆ«ä¸ºç‰¹æ®Šåœ°åŒº",
                    "DNSè§£æè¿”å›ç¾å›½èŠ‚ç‚¹è€Œéé¦™æ¸¯èŠ‚ç‚¹",
                    "é¿å…è·¨å¢ƒç½‘ç»œçš„å¤æ‚æ€§"
                ],
                "evidence": "dig @8.8.8.8 your-domain.cloudfront.net åœ¨ä¸åŒåœ°åŒºè¿”å›ä¸åŒIP"
            },
            
            "2. BGPè·¯ç”±ç­–ç•¥": {
                "description": "è¾¹ç•Œç½‘å…³åè®®è·¯ç”±ä¼˜åŒ–",
                "technical_detail": "AWSæ§åˆ¶BGPå…¬å‘Šï¼Œå½±å“æµé‡è·¯ç”±è·¯å¾„",
                "china_impact": [
                    "ä¸­å›½ISPçš„BGPè·¯ç”±è¡¨è¢«ç‰¹æ®Šé…ç½®",
                    "åˆ°é¦™æ¸¯çš„è·¯ç”±è¢«é™ä½ä¼˜å…ˆçº§",
                    "ç¾å›½èŠ‚ç‚¹è¢«ä¼˜å…ˆé€‰æ‹©"
                ],
                "evidence": "tracerouteæ˜¾ç¤ºä¸­å›½åˆ°CloudFrontçš„è·¯å¾„ç»•è¿‡é¦™æ¸¯"
            },
            
            "3. ç½‘ç»œè´¨é‡è€ƒè™‘": {
                "description": "è·¨å¢ƒç½‘ç»œè¿æ¥çš„è´¨é‡é—®é¢˜",
                "technical_detail": "ä¸­å›½å¤§é™†åˆ°é¦™æ¸¯çš„ç½‘ç»œè´¨é‡ä¸ç¨³å®š",
                "china_impact": [
                    "è·¨å¢ƒé“¾è·¯å®¹æ˜“å‡ºç°æ‹¥å¡",
                    "å»¶è¿Ÿå’Œä¸¢åŒ…ç‡è¾ƒé«˜",
                    "ç”¨æˆ·ä½“éªŒå¯èƒ½ä¸å¦‚ç¾å›½èŠ‚ç‚¹"
                ],
                "evidence": "pingå’Œtracerouteæµ‹è¯•æ˜¾ç¤ºè·¨å¢ƒå»¶è¿Ÿæ³¢åŠ¨å¤§"
            },
            
            "4. å®¹é‡å’Œè´Ÿè½½å‡è¡¡": {
                "description": "é¦™æ¸¯èŠ‚ç‚¹å®¹é‡é™åˆ¶",
                "technical_detail": "é¦™æ¸¯èŠ‚ç‚¹ä¸»è¦æœåŠ¡é¦™æ¸¯å’Œä¸œå—äºšç”¨æˆ·",
                "china_impact": [
                    "14äº¿ä¸­å›½ç”¨æˆ·ä¼šå‹å®é¦™æ¸¯èŠ‚ç‚¹",
                    "éœ€è¦ä¸“é—¨çš„å¤§å®¹é‡èŠ‚ç‚¹æœåŠ¡ä¸­å›½",
                    "è´Ÿè½½å‡è¡¡ç­–ç•¥é¿å…å•ç‚¹è¿‡è½½"
                ],
                "evidence": "AWSåœ¨ä¸­å›½è®¾ç«‹ä¸“é—¨çš„åŒºåŸŸå’ŒèŠ‚ç‚¹"
            }
        }
        
        for key, factor in technical_factors.items():
            print(f"\nğŸ” {key}")
            print(f"   æè¿°: {factor['description']}")
            print(f"   æŠ€æœ¯ç»†èŠ‚: {factor['technical_detail']}")
            print(f"   å¯¹ä¸­å›½çš„å½±å“:")
            for impact in factor['china_impact']:
                print(f"     â€¢ {impact}")
            print(f"   éªŒè¯æ–¹æ³•: {factor['evidence']}")
    
    def analyze_business_factors(self):
        """åˆ†æå•†ä¸šç­–ç•¥å› ç´ """
        print(f"\nğŸ’¼ å•†ä¸šç­–ç•¥å› ç´ åˆ†æ")
        print("=" * 60)
        
        business_factors = {
            "1. AWSä¸­å›½æˆ˜ç•¥": {
                "motivation": "æ¨åŠ¨AWSä¸­å›½åŒºåŸŸçš„å•†ä¸šæˆåŠŸ",
                "strategy": [
                    "å¼•å¯¼ä¸­å›½ç”¨æˆ·ä½¿ç”¨AWSä¸­å›½åŒºåŸŸ",
                    "ä¸ä¸­å›½åˆä½œä¼™ä¼´(å…‰ç¯æ–°ç½‘ã€è¥¿äº‘æ•°æ®)åˆä½œ",
                    "é¿å…é¦™æ¸¯èŠ‚ç‚¹åˆ†æµä¸­å›½åŒºåŸŸæ”¶å…¥"
                ],
                "impact": "é€šè¿‡æŠ€æœ¯æ‰‹æ®µå¼•å¯¼ç”¨æˆ·é€‰æ‹©åˆè§„çš„ä¸­å›½åŒºåŸŸæœåŠ¡"
            },
            
            "2. åˆè§„æˆæœ¬æ§åˆ¶": {
                "motivation": "é™ä½è·¨å¢ƒæœåŠ¡çš„åˆè§„æˆæœ¬",
                "strategy": [
                    "é¿å…é¦™æ¸¯èŠ‚ç‚¹æœåŠ¡ä¸­å›½å¤§é™†çš„åˆè§„é£é™©",
                    "å‡å°‘è·¨å¢ƒæ•°æ®ä¼ è¾“çš„å®¡æŸ¥æˆæœ¬",
                    "ä¸“æ³¨äºå·²åˆè§„çš„åŒºåŸŸæœåŠ¡"
                ],
                "impact": "é€šè¿‡è·¯ç”±ç­–ç•¥è‡ªåŠ¨è§„é¿åˆè§„å¤æ‚æ€§"
            },
            
            "3. ç«äº‰ç­–ç•¥": {
                "motivation": "ä¸æœ¬åœŸCDNæœåŠ¡å•†çš„ç«äº‰è€ƒè™‘",
                "strategy": [
                    "é¿å…ä¸é˜¿é‡Œäº‘ã€è…¾è®¯äº‘ç­‰ç›´æ¥ä»·æ ¼ç«äº‰",
                    "ä¸“æ³¨äºä¼ä¸šçº§å’Œè·¨å›½å…¬å¸å®¢æˆ·",
                    "é€šè¿‡å·®å¼‚åŒ–æœåŠ¡è·å¾—ç«äº‰ä¼˜åŠ¿"
                ],
                "impact": "ä¸ä¸æœ¬åœŸCDNåœ¨ä»·æ ¼æ•æ„Ÿçš„å¸‚åœºæ­£é¢ç«äº‰"
            },
            
            "4. é£é™©ç®¡ç†": {
                "motivation": "æœ€å°åŒ–æ”¿ç­–å’ŒæŠ€æœ¯é£é™©",
                "strategy": [
                    "é‡‡ç”¨ä¿å®ˆçš„è·¯ç”±ç­–ç•¥",
                    "é¿å…å¯èƒ½çš„æ”¿ç­–å†²çª",
                    "ç¡®ä¿é•¿æœŸä¸šåŠ¡ç¨³å®šæ€§"
                ],
                "impact": "å®å¯ç‰ºç‰²éƒ¨åˆ†æ€§èƒ½ä¹Ÿè¦ç¡®ä¿åˆè§„å’Œç¨³å®š"
            }
        }
        
        for key, factor in business_factors.items():
            print(f"\nğŸ’° {key}")
            print(f"   å•†ä¸šåŠ¨æœº: {factor['motivation']}")
            print(f"   å…·ä½“ç­–ç•¥:")
            for strategy in factor['strategy']:
                print(f"     â€¢ {strategy}")
            print(f"   å®é™…å½±å“: {factor['impact']}")
    
    def analyze_network_evidence(self):
        """åˆ†æç½‘ç»œè¯æ®"""
        print(f"\nğŸŒ ç½‘ç»œè·¯ç”±è¯æ®åˆ†æ")
        print("=" * 60)
        
        # æ¨¡æ‹Ÿä¸åŒåœ°åŒºçš„DNSè§£æç»“æœ
        regions_dns = {
            "ä¸­å›½å¤§é™†": {
                "dns_server": "114.114.114.114",
                "typical_result": "SFO53-P2 (ç¾å›½åŠ å·)",
                "reason": "AWS DNSè¿”å›ç¾å›½èŠ‚ç‚¹IP"
            },
            "é¦™æ¸¯": {
                "dns_server": "8.8.8.8", 
                "typical_result": "HKG62-C1 (é¦™æ¸¯)",
                "reason": "æ­£å¸¸è¿”å›é¦™æ¸¯èŠ‚ç‚¹IP"
            },
            "å°æ¹¾": {
                "dns_server": "168.95.1.1",
                "typical_result": "HKG62-C1 (é¦™æ¸¯)",
                "reason": "ä½œä¸ºæµ·å¤–åœ°åŒºæ­£å¸¸è·¯ç”±"
            },
            "æ–°åŠ å¡": {
                "dns_server": "8.8.8.8",
                "typical_result": "SIN52-C1 (æ–°åŠ å¡)",
                "reason": "è·¯ç”±åˆ°æœ€è¿‘çš„äºšå¤ªèŠ‚ç‚¹"
            }
        }
        
        print("ğŸ“Š ä¸åŒåœ°åŒºDNSè§£æå¯¹æ¯”:")
        for region, data in regions_dns.items():
            print(f"\nğŸŒ {region}:")
            print(f"   DNSæœåŠ¡å™¨: {data['dns_server']}")
            print(f"   è§£æç»“æœ: {data['typical_result']}")
            print(f"   åŸå› åˆ†æ: {data['reason']}")
    
    def provide_workaround_solutions(self):
        """æä¾›ç»•è¿‡æ–¹æ¡ˆ"""
        print(f"\nğŸš€ ç»•è¿‡é™åˆ¶çš„æŠ€æœ¯æ–¹æ¡ˆ")
        print("=" * 60)
        
        solutions = {
            "1. å¼ºåˆ¶é¦™æ¸¯èŠ‚ç‚¹è®¿é—®": {
                "method": "ç›´æ¥ä½¿ç”¨é¦™æ¸¯èŠ‚ç‚¹IP",
                "implementation": [
                    "é€šè¿‡digè·å–é¦™æ¸¯èŠ‚ç‚¹çš„çœŸå®IP",
                    "ä¿®æ”¹hostsæ–‡ä»¶å¼ºåˆ¶æŒ‡å‘é¦™æ¸¯IP",
                    "ä½¿ç”¨CDNå›æºåˆ°é¦™æ¸¯èŠ‚ç‚¹"
                ],
                "effectiveness": "æœ‰æ•ˆï¼Œä½†éœ€è¦ç»´æŠ¤IPåˆ—è¡¨",
                "risks": ["IPå¯èƒ½å˜åŒ–", "å¯èƒ½è¿åAWS ToS", "æŠ€æœ¯å¤æ‚åº¦é«˜"]
            },
            
            "2. VPN/ä»£ç†æ–¹æ¡ˆ": {
                "method": "é€šè¿‡é¦™æ¸¯VPN/ä»£ç†è®¿é—®",
                "implementation": [
                    "ä½¿ç”¨é¦™æ¸¯çš„VPNæœåŠ¡",
                    "é€šè¿‡ä»£ç†æœåŠ¡å™¨ä¸­è½¬",
                    "ä¼ªè£…æˆé¦™æ¸¯ç”¨æˆ·è®¿é—®"
                ],
                "effectiveness": "é«˜æ•ˆï¼Œä½†ä¾èµ–ä»£ç†ç¨³å®šæ€§",
                "risks": ["å¢åŠ å»¶è¿Ÿ", "ä»£ç†æœåŠ¡æˆæœ¬", "åˆè§„é£é™©"]
            },
            
            "3. æ··åˆCDNæ¶æ„": {
                "method": "ç»„åˆä½¿ç”¨å¤šä¸ªCDNæœåŠ¡",
                "implementation": [
                    "ä¸­å›½å¤§é™†ï¼šé˜¿é‡Œäº‘CDN + è…¾è®¯äº‘CDN",
                    "é¦™æ¸¯å°æ¹¾ï¼šAWS CloudFronté¦™æ¸¯èŠ‚ç‚¹", 
                    "å…¶ä»–åœ°åŒºï¼šAWS CloudFrontå…¨çƒèŠ‚ç‚¹"
                ],
                "effectiveness": "æœ€ä½³ç”¨æˆ·ä½“éªŒ",
                "risks": ["æ¶æ„å¤æ‚", "æˆæœ¬è¾ƒé«˜", "ç»´æŠ¤å·¥ä½œé‡å¤§"]
            },
            
            "4. AWSä¸­å›½åŒºåŸŸ": {
                "method": "å®Œå…¨è¿ç§»åˆ°AWSä¸­å›½åŒºåŸŸ",
                "implementation": [
                    "ç”³è¯·AWSä¸­å›½è´¦æˆ·",
                    "å®ŒæˆICPå¤‡æ¡ˆæµç¨‹",
                    "è¿ç§»æœåŠ¡åˆ°cn-north-1/cn-northwest-1"
                ],
                "effectiveness": "æ ¹æœ¬æ€§è§£å†³æ–¹æ¡ˆ",
                "risks": ["è¿ç§»æˆæœ¬é«˜", "åŠŸèƒ½å¯èƒ½æœ‰é™", "å¤‡æ¡ˆå‘¨æœŸé•¿"]
            }
        }
        
        for key, solution in solutions.items():
            print(f"\nğŸ”§ {key}")
            print(f"   æ–¹æ³•: {solution['method']}")
            print(f"   å®æ–½æ­¥éª¤:")
            for step in solution['implementation']:
                print(f"     â€¢ {step}")
            print(f"   æœ‰æ•ˆæ€§: {solution['effectiveness']}")
            print(f"   é£é™©:")
            for risk in solution['risks']:
                print(f"     âš ï¸ {risk}")
    
    def generate_comprehensive_report(self):
        """ç”Ÿæˆç»¼åˆåˆ†ææŠ¥å‘Š"""
        print(f"\nğŸ“‹ ç»¼åˆåˆ†ææŠ¥å‘Š")
        print("=" * 60)
        
        report = {
            "é—®é¢˜æ ¸å¿ƒ": "AWSé€šè¿‡æŠ€æœ¯å’Œç­–ç•¥æ‰‹æ®µé˜»æ­¢ä¸­å›½å¤§é™†ç”¨æˆ·è®¿é—®é¦™æ¸¯èŠ‚ç‚¹",
            "ä¸»è¦åŸå› ": [
                "ğŸ›ï¸ æ”¿ç­–åˆè§„: é¿å…è·¨å¢ƒæ•°æ®ä¼ è¾“çš„åˆè§„é£é™©",
                "ğŸ’¼ å•†ä¸šç­–ç•¥: æ¨åŠ¨AWSä¸­å›½åŒºåŸŸçš„å•†ä¸šæˆåŠŸ",
                "ğŸ”§ æŠ€æœ¯è€ƒè™‘: DNSè§£æå’ŒBGPè·¯ç”±çš„ç‰¹æ®Šé…ç½®",
                "âš–ï¸ é£é™©ç®¡ç†: æœ€å°åŒ–æ”¿ç­–å’ŒæŠ€æœ¯é£é™©"
            ],
            "å½±å“ç¨‹åº¦": {
                "æ”¿ç­–å› ç´ ": "90% - æœ€å…³é”®çš„å†³å®šæ€§å› ç´ ",
                "å•†ä¸šç­–ç•¥": "80% - é‡è¦çš„å•†ä¸šè€ƒè™‘", 
                "æŠ€æœ¯å› ç´ ": "70% - æ”¯æ’‘æ”¿ç­–çš„æŠ€æœ¯æ‰‹æ®µ",
                "ç”¨æˆ·ä½“éªŒ": "60% - ç›¸å¯¹æ¬¡è¦çš„è€ƒè™‘"
            },
            "è§£å†³æ–¹æ¡ˆæ’åº": [
                "1. AWSä¸­å›½åŒºåŸŸ (å½»åº•è§£å†³ï¼Œåˆè§„æ— é£é™©)",
                "2. æ··åˆCDNæ¶æ„ (æ•ˆæœå¥½ï¼Œä½†å¤æ‚)",
                "3. VPN/ä»£ç†æ–¹æ¡ˆ (å¿«é€Ÿï¼Œä½†æœ‰é£é™©)",
                "4. æŠ€æœ¯ç»•è¿‡ (ä¸´æ—¶ï¼Œç»´æŠ¤æˆæœ¬é«˜)"
            ]
        }
        
        print(f"ğŸ¯ {report['é—®é¢˜æ ¸å¿ƒ']}")
        print(f"\nğŸ“Š ä¸»è¦åŸå› åˆ†æ:")
        for reason in report['ä¸»è¦åŸå› ']:
            print(f"   {reason}")
            
        print(f"\nğŸ“ˆ å½±å“ç¨‹åº¦è¯„ä¼°:")
        for factor, impact in report['å½±å“ç¨‹åº¦'].items():
            print(f"   {factor}: {impact}")
            
        print(f"\nğŸ† æ¨èè§£å†³æ–¹æ¡ˆ (æŒ‰ä¼˜å…ˆçº§):")
        for solution in report['è§£å†³æ–¹æ¡ˆæ’åº']:
            print(f"   {solution}")

def main():
    analyzer = ChinaHKRoutingAnalyzer()
    
    print("ğŸ” ä¸­å›½å¤§é™†ç”¨æˆ·æ— æ³•è®¿é—®é¦™æ¸¯CloudFrontèŠ‚ç‚¹åˆ†æ")
    print("æ·±å…¥è§£ææ”¿ç­–ã€æŠ€æœ¯ã€å•†ä¸šç­‰å¤šé‡å› ç´ ")
    print(f"åˆ†ææ—¶é—´: {datetime.now().strftime('%Y-%m-%d %H:%M:%S')}")
    
    # æ‰§è¡Œå„é¡¹åˆ†æ
    analyzer.analyze_policy_factors()
    analyzer.analyze_technical_factors() 
    analyzer.analyze_business_factors()
    analyzer.analyze_network_evidence()
    analyzer.provide_workaround_solutions()
    analyzer.generate_comprehensive_report()
    
    print(f"\nğŸ’¡ ç»“è®º:")
    print("AWSä¸è®©ä¸­å›½å¤§é™†ç”¨æˆ·è®¿é—®é¦™æ¸¯èŠ‚ç‚¹æ˜¯ä¸€ä¸ª")
    print("æ”¿ç­–åˆè§„ã€å•†ä¸šç­–ç•¥ã€æŠ€æœ¯å®ç°çš„ç»¼åˆå†³ç­–")
    print("æœ€æ ¹æœ¬çš„è§£å†³æ–¹æ¡ˆæ˜¯ä½¿ç”¨AWSä¸­å›½åŒºåŸŸæˆ–æ··åˆCDNæ¶æ„")

if __name__ == "__main__":
    main() 